// Generated by CoffeeScript 1.7.1
(function() {
  "use strict";
  angular.module("fbpoc.CompanyFormCtrl", []).controller("CompanyFormCtrl", [
    "$scope", "$routeParams", "$log", "$builder", "$validator", "sessionService", "dataService", function($scope, $routeParams, $log, $builder, $validator, sessionService, dataService) {
      var get_kv, init, init_select, name_pos, o_code_format_type, o_company, o_currencycode, o_domainmanagerid, o_objectclass, o_texths, obj_list, set_sysdata;
      $scope.table = "company";
      $scope.system = {
        modifiedon: null,
        modifiedby: null,
        createdon: null,
        createdby: null,
        rowversion: null
      };
      name_pos = {};
      o_company = {
        name: "company",
        component: "sampleInput",
        label: "company",
        description: "",
        placeholder: "company",
        required: true,
        editable: false
      };
      o_texths = {
        name: "texths",
        component: "sampleInput",
        label: "texths",
        description: "",
        placeholder: "texths",
        required: false,
        editable: false
      };
      o_currencycode = {
        name: "currencycode",
        component: "select4",
        label: "currencycode",
        description: "",
        placeholder: "currencycode",
        required: false,
        editable: false
      };
      o_code_format_type = {
        name: "code_format_type",
        component: "select4",
        label: "code_format_type",
        description: "",
        placeholder: "code_format_type",
        required: false,
        editable: false
      };
      o_domainmanagerid = {
        name: "domainmanagerid",
        component: "sampleInput",
        label: "domainmanagerid",
        description: "",
        placeholder: "domainmanagerid",
        required: false,
        editable: false
      };
      o_objectclass = {
        name: "objectclass",
        component: "sampleInput",
        label: "objectclass",
        description: "",
        placeholder: "objectclass",
        required: false,
        editable: false
      };
      $scope.pkey = 'company';
      obj_list = [o_company, o_texths, o_currencycode, o_code_format_type, o_domainmanagerid, o_objectclass];
      init_select = function() {};
      init = function() {
        var j, obj;
        j = 0;
        $scope.zmodel = [];
        $scope.defaultValue = {};
        j = 0;
        while (j < obj_list.length) {
          obj = obj_list[j];
          name_pos[obj.name] = j;
          if ("default_" in obj) {
            $scope.defaultValue[j] = obj.default_;
          }
          $builder.addFormObject("zform", obj);
          j++;
        }
        $scope.zform = $builder.forms["zform"];
        init_select();
      };
      get_kv = function(field) {
        return dataService.getkv(params).then(function(data) {
          return $log.debug(data);
        }, function(result) {
          return $log.debug("error", data);
        });
      };
      init_select = function() {
        var field, select_fields, _i, _len, _results;
        select_fields = [];
        _results = [];
        for (_i = 0, _len = select_fields.length; _i < _len; _i++) {
          field = select_fields[_i];
          _results.push(get_kv(field));
        }
        return _results;
      };
      set_sysdata = function(data) {
        var col, cols, _i, _len, _results;
        cols = ["modifiedon", "modifiedby", "createdon", "createdby", "rowversion"];
        _results = [];
        for (_i = 0, _len = cols.length; _i < _len; _i++) {
          col = cols[_i];
          _results.push($scope.system[col] = data[col]);
        }
        return _results;
      };
      $scope.get = function() {
        return dataService.get(params).then(function(data) {
          $log.debug(data);
          return $scope.defaultValue[0] = "abc";
        }, function(result) {
          return $log.debug("error", result);
        });
      };
      $scope.refresh = function() {
        return $scope.get();
      };
      $scope.save = function() {
        var context, fields, item, params, _i, _len, _ref;
        fields = {};
        if ($scope.system.rowversion) {
          fields.rowversion = $scope.system.rowversion;
        }
        context = {
          languageid: 1033,
          user: 'idea'
        };
        _ref = $scope.zmodel;
        for (_i = 0, _len = _ref.length; _i < _len; _i++) {
          item = _ref[_i];
          if (item.value.length === 0) {
            fields[item.name] = null;
          } else {
            fields[item.name] = item.value;
          }
        }
        params = {
          table: $scope.table,
          pkey: $scope.pkey,
          columns: fields,
          context: context
        };
        $log.debug(fields);
        $log.debug(params);
        return dataService.save(params).then(function(data) {
          var pos;
          $scope.system = data.returning[0];
          pos = name_pos['company'];
          $builder.forms["zform"][pos].readonly = true;
          return $log.debug(data);
        }, function(reason) {
          return $log.debug("error", reason);
        });
      };
      return init();
    }
  ]);

}).call(this);
